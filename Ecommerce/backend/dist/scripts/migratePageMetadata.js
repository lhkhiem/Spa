"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const database_1 = __importDefault(require("../config/database"));
const PageMetadata_1 = __importDefault(require("../models/PageMetadata"));
const metadataHelpers_1 = require("../utils/metadataHelpers");
/**
 * Normalize path to match how it's stored in database
 */
function normalizePath(path) {
    if (!path)
        return '';
    if (path.startsWith('/products/')) {
        const slug = path.replace('/products/', '');
        return `/products/${(0, metadataHelpers_1.normalizeSlug)(slug)}`;
    }
    if (path.startsWith('/posts/')) {
        const slug = path.replace('/posts/', '');
        return `/posts/${(0, metadataHelpers_1.normalizeSlug)(slug)}`;
    }
    return path.startsWith('/') ? path : `/${path}`;
}
/**
 * Migrate page metadata from settings JSONB to page_metadata table
 */
async function migratePageMetadata() {
    try {
        await database_1.default.authenticate();
        console.log('âœ… Database connected');
        // 1. Read from settings table
        const [seoRow] = await database_1.default.query('SELECT value FROM settings WHERE namespace = :ns', {
            type: 'SELECT',
            replacements: { ns: 'seo' },
        });
        if (!seoRow || seoRow.length === 0 || !seoRow[0]?.value) {
            console.log('âš ï¸  No SEO settings found in settings table');
            return;
        }
        const seoSettings = seoRow[0].value;
        const pages = seoSettings.pages || [];
        if (pages.length === 0) {
            console.log('âš ï¸  No pages found in SEO settings');
            return;
        }
        console.log(`ğŸ“¦ Found ${pages.length} pages in settings to migrate`);
        // 2. Migrate each page to page_metadata table
        let migrated = 0;
        let skipped = 0;
        let errors = 0;
        for (const page of pages) {
            if (!page || !page.path) {
                console.warn('âš ï¸  Skipping page without path:', page);
                skipped++;
                continue;
            }
            try {
                const normalizedPath = normalizePath(page.path);
                // Check if already exists
                const existing = await PageMetadata_1.default.findOne({
                    where: { path: normalizedPath },
                });
                if (existing) {
                    console.log(`â­ï¸  Page already exists: ${normalizedPath}`);
                    skipped++;
                    continue;
                }
                // Create new
                await PageMetadata_1.default.create({
                    path: normalizedPath,
                    title: page.title || null,
                    description: page.description || null,
                    og_image: page.ogImage || null,
                    keywords: Array.isArray(page.keywords) && page.keywords.length > 0 ? page.keywords : null,
                    enabled: page.enabled !== undefined ? page.enabled : true,
                    auto_generated: page.autoGenerated !== undefined ? page.autoGenerated : false,
                });
                console.log(`âœ… Migrated: ${normalizedPath}`);
                migrated++;
            }
            catch (error) {
                console.error(`âŒ Error migrating page ${page.path}:`, error.message);
                errors++;
            }
        }
        console.log('\nğŸ“Š Migration Summary:');
        console.log(`   âœ… Migrated: ${migrated}`);
        console.log(`   â­ï¸  Skipped: ${skipped}`);
        console.log(`   âŒ Errors: ${errors}`);
        console.log(`   ğŸ“¦ Total: ${pages.length}`);
        await database_1.default.close();
    }
    catch (error) {
        console.error('âŒ Migration failed:', error);
        process.exit(1);
    }
}
// Run migration
migratePageMetadata();
//# sourceMappingURL=migratePageMetadata.js.map