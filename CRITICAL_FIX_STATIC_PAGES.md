# CRITICAL FIX: Static Pages Bị Xóa

## Vấn đề
Sau khi thêm sản phẩm mới, trang tĩnh `/product` (autoGenerated: false) bị xóa mất.

## Nguyên nhân
Logic filter có thể có bug hoặc validation không đủ chặt.

## Đã sửa

### 1. Cải thiện logging
- ✅ Log từng page được preserve
- ✅ Log từng page bị filter out
- ✅ Log chi tiết khi validation fail

### 2. Cải thiện validation
- ✅ Kiểm tra từng static page có còn trong preserved list không
- ✅ Throw error với danh sách pages bị mất
- ✅ Không save nếu có risk mất data

### 3. Logic filter rõ ràng hơn
- ✅ Chỉ filter out: `autoGenerated === true && path.startsWith('/products/')`
- ✅ Giữ TẤT CẢ các pages khác (bao gồm `/product` với autoGenerated: false)

## Build lại

```bash
cd /var/www/Spa/CMS/backend
npm run build
pm2 restart cms-backend
```

## Test

1. **Kiểm tra SEO trước:**
   ```bash
   node check-seo.js
   ```
   Ghi lại tất cả static pages.

2. **Thêm/duplicate một product**

3. **Kiểm tra SEO sau:**
   ```bash
   node check-seo.js
   ```
   Tất cả static pages phải còn nguyên.

4. **Kiểm tra logs:**
   ```bash
   pm2 logs cms-backend | grep syncProductMetadata
   ```
   Sẽ thấy:
   - `Keeping page: /product (autoGenerated: false)`
   - `Preserved: /product (autoGenerated: false)`
   - `Validation passed: All X static pages preserved`

## Nếu vẫn bị xóa

Logs sẽ hiển thị:
- `CRITICAL ERROR: Lost static pages!`
- Danh sách pages bị mất
- Error sẽ được throw và không save (product vẫn được tạo, nhưng metadata không sync)

Điều này đảm bảo không bao giờ mất static pages.
