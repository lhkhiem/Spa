"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.deletePageMetadata = exports.savePageMetadata = exports.getPageMetadata = exports.getAllPageMetadata = void 0;
const PageMetadata_1 = __importDefault(require("../models/PageMetadata"));
const metadataHelpers_1 = require("../utils/metadataHelpers");
/**
 * Normalize path to match how it's stored in database
 */
function normalizePath(path) {
    if (!path)
        return '';
    // Extract slug from path if it's a product/post path
    if (path.startsWith('/products/')) {
        const slug = path.replace('/products/', '');
        return `/products/${(0, metadataHelpers_1.normalizeSlug)(slug)}`;
    }
    if (path.startsWith('/posts/')) {
        const slug = path.replace('/posts/', '');
        return `/posts/${(0, metadataHelpers_1.normalizeSlug)(slug)}`;
    }
    // For other paths, return as-is (but ensure it starts with /)
    return path.startsWith('/') ? path : `/${path}`;
}
/**
 * Get all page metadata (for CMS admin)
 */
const getAllPageMetadata = async (req, res) => {
    try {
        if (!req.user) {
            return res.status(401).json({ error: 'Unauthorized' });
        }
        const pages = await PageMetadata_1.default.findAll({
            order: [['path', 'ASC']],
        });
        // Transform to match frontend format
        const formatted = pages.map((page) => ({
            path: page.path,
            title: page.title || '',
            description: page.description || '',
            ogImage: page.og_image || '',
            keywords: page.keywords || [],
            enabled: page.enabled,
            autoGenerated: page.auto_generated,
        }));
        res.json({ pages: formatted });
    }
    catch (error) {
        console.error('[getAllPageMetadata] Error:', error);
        res.status(500).json({ error: 'Failed to load page metadata' });
    }
};
exports.getAllPageMetadata = getAllPageMetadata;
/**
 * Get single page metadata
 */
const getPageMetadata = async (req, res) => {
    try {
        if (!req.user) {
            return res.status(401).json({ error: 'Unauthorized' });
        }
        const { path: rawPath } = req.params;
        const path = normalizePath(rawPath);
        const page = await PageMetadata_1.default.findOne({
            where: { path },
        });
        if (!page) {
            return res.status(404).json({ error: 'Page metadata not found' });
        }
        res.json({
            path: page.path,
            title: page.title || '',
            description: page.description || '',
            ogImage: page.og_image || '',
            keywords: page.keywords || [],
            enabled: page.enabled,
            autoGenerated: page.auto_generated,
        });
    }
    catch (error) {
        console.error('[getPageMetadata] Error:', error);
        res.status(500).json({ error: 'Failed to load page metadata' });
    }
};
exports.getPageMetadata = getPageMetadata;
/**
 * Create or update page metadata
 */
const savePageMetadata = async (req, res) => {
    try {
        if (!req.user) {
            return res.status(401).json({ error: 'Unauthorized' });
        }
        const { path: rawPath, title, description, ogImage, keywords, enabled, autoGenerated } = req.body;
        const path = normalizePath(rawPath);
        if (!path) {
            return res.status(400).json({ error: 'Path is required' });
        }
        // Check if page exists
        const existing = await PageMetadata_1.default.findOne({
            where: { path },
        });
        const metadataData = {
            path,
            title: title || null,
            description: description || null,
            og_image: ogImage || null,
            keywords: Array.isArray(keywords) && keywords.length > 0 ? keywords : null,
            enabled: enabled !== undefined ? enabled : true,
            auto_generated: autoGenerated !== undefined ? autoGenerated : false,
        };
        if (existing) {
            // Update existing
            // If it's auto-generated, only allow update if explicitly setting autoGenerated to false (making it custom)
            if (existing.auto_generated && autoGenerated !== false) {
                return res.status(403).json({
                    error: 'Cannot update auto-generated metadata. Set autoGenerated to false to make it custom.'
                });
            }
            await existing.update(metadataData);
            res.json({ message: 'Page metadata updated', path });
        }
        else {
            // Create new
            await PageMetadata_1.default.create(metadataData);
            res.json({ message: 'Page metadata created', path });
        }
    }
    catch (error) {
        console.error('[savePageMetadata] Error:', error);
        if (error.name === 'SequelizeUniqueConstraintError') {
            return res.status(409).json({ error: 'Page metadata with this path already exists' });
        }
        res.status(500).json({ error: 'Failed to save page metadata' });
    }
};
exports.savePageMetadata = savePageMetadata;
/**
 * Delete page metadata
 */
const deletePageMetadata = async (req, res) => {
    try {
        if (!req.user) {
            return res.status(401).json({ error: 'Unauthorized' });
        }
        const { path: rawPath } = req.params;
        const path = normalizePath(rawPath);
        const page = await PageMetadata_1.default.findOne({
            where: { path },
        });
        if (!page) {
            return res.status(404).json({ error: 'Page metadata not found' });
        }
        // Don't allow deleting auto-generated metadata (it will be recreated)
        if (page.auto_generated) {
            return res.status(403).json({
                error: 'Cannot delete auto-generated metadata. It will be recreated automatically.'
            });
        }
        await page.destroy();
        res.json({ message: 'Page metadata deleted', path });
    }
    catch (error) {
        console.error('[deletePageMetadata] Error:', error);
        res.status(500).json({ error: 'Failed to delete page metadata' });
    }
};
exports.deletePageMetadata = deletePageMetadata;
//# sourceMappingURL=pageMetadataController.js.map